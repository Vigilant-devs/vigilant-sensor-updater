name: Build, Sign & Publish Release

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write   # needed to create GitHub Releases and commit manifest

jobs:
  release:
    name: Build and Publish
    runs-on: ubuntu-latest

    steps:
      # -----------------------------------------------------------------------
      # 1. Checkout
      # -----------------------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      # -----------------------------------------------------------------------
      # 2. Extract version from tag (e.g. v2.0.1 → 2.0.1)
      # -----------------------------------------------------------------------
      - name: Extract version
        id: version
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          VERSION="${TAG#v}"
          echo "tag=${TAG}"     >> "$GITHUB_OUTPUT"
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "Release version: ${VERSION}"

      # -----------------------------------------------------------------------
      # 3. Import GPG private key
      # -----------------------------------------------------------------------
      - name: Import GPG private key
        run: |
          echo "${{ secrets.GPG_PRIVATE_KEY }}" | \
            gpg --batch --import --passphrase "${{ secrets.GPG_PASSPHRASE }}" 2>/dev/null || \
            gpg --batch --import 2>/dev/null || true

          # Verify key imported
          gpg --list-secret-keys updater@vigilant.com.br

      # -----------------------------------------------------------------------
      # 4. Pack release
      # -----------------------------------------------------------------------
      - name: Pack release
        run: |
          chmod +x tools/pack-release.sh
          ./tools/pack-release.sh "${{ steps.version.outputs.version }}"

      # -----------------------------------------------------------------------
      # 5. Sign package
      # -----------------------------------------------------------------------
      - name: Sign package with GPG
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          PACKAGE="dist/sensor-pack-v${VERSION}.tar.gz"
          SIG="${PACKAGE}.sig"

          if [[ -n "${{ secrets.GPG_PASSPHRASE }}" ]]; then
            echo "${{ secrets.GPG_PASSPHRASE }}" | \
              gpg --batch --yes --passphrase-fd 0 \
              --local-user updater@vigilant.com.br \
              --detach-sign --armor \
              --output "$SIG" "$PACKAGE"
          else
            gpg --batch --yes \
              --local-user updater@vigilant.com.br \
              --detach-sign --armor \
              --output "$SIG" "$PACKAGE"
          fi

          echo "Signature created: ${SIG}"
          gpg --verify "$SIG" "$PACKAGE" && echo "[OK] Signature verified."

      # -----------------------------------------------------------------------
      # 6. Prepare generic-named assets (sensors always use sensor-pack.tar.gz)
      # -----------------------------------------------------------------------
      - name: Prepare release assets
        id: assets
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          mkdir -p dist
          cp "dist/sensor-pack-v${VERSION}.tar.gz"     dist/sensor-pack.tar.gz
          cp "dist/sensor-pack-v${VERSION}.tar.gz.sig" dist/sensor-pack.tar.gz.sig
          cat "dist/sensor-pack-v${VERSION}.tar.gz.sha256" > dist/sensor-pack.tar.gz.sha256

          HASH=$(cat "dist/sensor-pack-v${VERSION}.tar.gz.sha256")
          echo "sha256=${HASH}" >> "$GITHUB_OUTPUT"
          echo "SHA256: ${HASH}"

      # -----------------------------------------------------------------------
      # 7. Update manifest.json
      # -----------------------------------------------------------------------
      - name: Update manifest.json
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          TAG="${{ steps.version.outputs.tag }}"
          HASH="${{ steps.assets.outputs.sha256 }}"
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          REPO="${{ github.repository }}"
          BASE_URL="https://github.com/${REPO}/releases/download/${TAG}"

          cat > manifest.json <<EOF
          {
            "version": "${VERSION}",
            "released_at": "${TIMESTAMP}",
            "download_url": "${BASE_URL}/sensor-pack.tar.gz",
            "sha256": "${HASH}",
            "gpg_sig_url": "${BASE_URL}/sensor-pack.tar.gz.sig",
            "min_supported_version": "2.0.0",
            "rollback_safe": true,
            "changelog": "Release ${TAG}"
          }
          EOF

          # Normalize JSON indentation
          python3 -c "import json,sys; d=json.load(open('manifest.json')); json.dump(d,open('manifest.json','w'),indent=2); open('manifest.json','a').write('\n')"
          cat manifest.json

      # -----------------------------------------------------------------------
      # 8. Commit manifest.json back to main
      # -----------------------------------------------------------------------
      - name: Commit manifest.json
        run: |
          git config user.name  "Ezequiel Senna"
          git config user.email "ezequiel.sena@vigilant.com.br"
          git add manifest.json
          git diff --staged --quiet || \
            git commit -m "ci: update manifest.json to ${{ steps.version.outputs.tag }} [skip ci]"
          git push origin HEAD:main

      # -----------------------------------------------------------------------
      # 9. Create GitHub Release with assets
      # -----------------------------------------------------------------------
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: ${{ steps.version.outputs.tag }}
          body: |
            ## Vigilant Sensor — ${{ steps.version.outputs.tag }}

            **SHA256:** `${{ steps.assets.outputs.sha256 }}`

            ### Assets
            - `sensor-pack.tar.gz` — update package
            - `sensor-pack.tar.gz.sig` — GPG signature (ASC armored)
            - `sensor-pack.tar.gz.sha256` — SHA256 checksum

            Sensors will automatically download and verify this release.
          files: |
            dist/sensor-pack.tar.gz
            dist/sensor-pack.tar.gz.sig
            dist/sensor-pack.tar.gz.sha256
