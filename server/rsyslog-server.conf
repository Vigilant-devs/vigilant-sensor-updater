# =============================================================================
# Vigilant Central Server — rsyslog receiver config
# File: /etc/rsyslog.d/40-vigilant-sensors.conf
#
# Recebe logs dos sensores Vigilant via VPN TCP 514.
# Salva eventos do vigilant-updater em arquivo dedicado com rotação.
#
# Instalação no servidor (177.190.148.68):
#   1. Copiar este arquivo:
#      cp server/rsyslog-server.conf /etc/rsyslog.d/40-vigilant-sensors.conf
#
#   2. Criar pasta de logs:
#      mkdir -p /var/log/vigilant
#      chmod 750 /var/log/vigilant
#
#   3. Liberar porta 514 somente para IPs da VPN:
#      firewall-cmd --permanent --add-rich-rule='rule family="ipv4" source address="192.168.100.0/24" port port="514" protocol="tcp" accept'
#      firewall-cmd --reload
#      (Ajuste o range 192.168.100.0/24 para o range real da sua VPN L2TP)
#
#   4. Reiniciar rsyslog:
#      systemctl restart rsyslog
#
#   5. Verificar:
#      ss -tlnp | grep 514
#      tail -f /var/log/vigilant/sensor-updates.log
# =============================================================================

# --- Habilitar recepção TCP na porta 514 ---
module(load="imtcp")
input(type="imtcp" port="514")

# --- Salvar eventos do vigilant-updater em arquivo dedicado ---
# Formato: timestamp  hostname  syslogtag  mensagem
# O syslogtag ("vigilant-updater:") é necessário para o Promtail parsear os campos.
$template VigilantFormat,"%TIMESTAMP:::date-rfc3339% %HOSTNAME% %syslogtag%%msg%\n"

if $programname == 'vigilant-updater' then {
    action(
        type="omfile"
        file="/var/log/vigilant/sensor-updates.log"
        template="VigilantFormat"
        # Flush imediato — cada evento é gravado na hora (importante para auditoria)
        flushOnTXEnd="on"
    )
    stop
}
